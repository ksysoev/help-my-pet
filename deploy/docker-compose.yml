services:
  redis:
    image: redis:7
    networks:
      - backend
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  help-my-pet:
    image: "ghcr.io/ksysoev/help-my-pet:${VERSION:-main}"
    networks:
      - backend
    environment:
      - AI_API_KEY=${AI_API_KEY}
      - BOT_TELEGRAM_TOKEN=${BOT_TELEGRAM_TOKEN}
      - REDIS_URL=redis:6379
      - AI_MODEL=${AI_MODEL:-claude-sonnet-4-6}
      - AI_MEDIA_MODEL=${AI_MEDIA_MODEL:-claude-haiku-4-5}
      - AI_MAX_TOKENS=${AI_MAX_TOKENS:-1000}
      - RATE_LIMIT_USER_HOURLY_LIMIT=${RATE_LIMIT_USER_HOURLY_LIMIT:-5}
      - RATE_LIMIT_USER_DAILY_LIMIT=${RATE_LIMIT_USER_DAILY_LIMIT:-15}
      - RATE_LIMIT_GLOBAL_DAILY_LIMIT=${RATE_LIMIT_GLOBAL_DAILY_LIMIT:-4000}
    depends_on:
      - redis
    deploy:
      replicas: 1
      update_config:
        order: stop-first
        failure_action: rollback
      restart_policy:
        condition: any
        delay: 5s

networks:
  backend:
    driver: overlay
    name: ${NETWORK_NAME:-helpmypet-network}

volumes:
  redis_data:
    driver: local
